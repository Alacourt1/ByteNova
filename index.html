<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Bomberos - Sistema con Admin</title>
<script src="https://kit.fontawesome.com/a2e0b6c15a.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f4f5f7;color:#333;}
.hidden{display:none;}
header{background:#1e293b;color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
header button{background:#ef4444;color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;transition:0.3s;}
header button:hover{background:#dc2626;}
nav{background:#111827;display:flex;gap:1px;}
nav a{flex:1;color:#fff;text-align:center;padding:12px 0;text-decoration:none;transition:0.3s;}
nav a.active,nav a:hover{background:#2563eb;}
.container{padding:20px;}
h2{margin-bottom:15px;color:#111827;text-align:center;}
form{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);max-width:400px;margin:auto;}
input,select,textarea,button{width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;font-size:14px;}
button{background:#2563eb;color:#fff;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#1d4ed8;}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0;}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center;}
.card h3{margin-bottom:10px;color:#1f2937;font-weight:500;}
.card .value{font-size:2rem;font-weight:bold;color:#2563eb;}
.alert{padding:15px;margin:10px 0;border-radius:8px;text-align:center;}
.alert-success{background:#d1fae5;color:#065f46;}
.alert-error{background:#fee2e2;color:#991b1b;}
.alert-info{background:#bfdbfe;color:#1e3a8a;}
.popup{position:fixed;top:20px;right:20px;background:#34d399;color:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.2);animation:popupAnim 0.5s forwards;z-index:1000;}
@keyframes popupAnim{from{opacity:0;transform:translateX(50px);}to{opacity:1;transform:translateX(0);}}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.05);}
th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd;}
th{background:#2563eb;color:#fff;}
tr:hover{background:#f3f4f6;}
.badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;}
.badge-success{background:#10b981;color:white;}
.badge-warning{background:#f59e0b;color:white;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="container">
<h2>Login Sistema Bomberos</h2>
<form id="login-form">
<input type="text" id="login-user" placeholder="Usuario" required>
<input type="password" id="login-password" placeholder="Contraseña" required>
<button type="submit"><i class="fas fa-sign-in-alt"></i> Ingresar</button>
</form>
<div id="login-error" class="alert alert-error hidden"></div>
</div>

<!-- SISTEMA USUARIO NORMAL -->
<div id="main-system" class="hidden">
<header>
<span id="user-name"></span> - <span id="user-rank"></span>
<button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
</header>
<nav>
<a href="#dashboard" class="nav-link active">Dashboard</a>
<a href="#ingreso" class="nav-link">Ingreso</a>
<a href="#salida" class="nav-link">Salida</a>
<a href="#historial" class="nav-link">Historial</a>
</nav>

<div class="container tab-content" id="dashboard">
<h2>Dashboard</h2>
<div class="alert alert-info" id="estado-actual">Sin guardia activa</div>
<div class="dashboard-grid">
<div class="card"><h3>Horas este mes</h3><div class="value" id="horas-mes">0</div></div>
<div class="card"><h3>Días trabajados</h3><div class="value" id="dias-trabajados">0</div></div>
<div class="card"><h3>Guardias completadas</h3><div class="value" id="guardias-completadas">0</div></div>
<div class="card"><h3>Promedio horas/día</h3><div class="value" id="promedio-horas">0</div></div>
</div>
<div style="max-width:600px;margin:auto;">
<canvas id="horasChart"></canvas>
</div>
</div>

<div class="container tab-content hidden" id="ingreso">
<h2>Registrar Ingreso</h2>
<form id="ingreso-form">
<input type="text" id="legajo" placeholder="Legajo" readonly>
<select id="actividad" required>
  <option value="">Selecciona actividad</option>
</select>
<textarea id="observaciones-ingreso" placeholder="Observaciones"></textarea>
<button type="submit"><i class="fas fa-sign-in-alt"></i> Registrar</button>
</form>
</div>

<div class="container tab-content hidden" id="salida">
<h2>Registrar Salida</h2>
<form id="salida-form">
<input type="text" id="legajo-salida" readonly>
<input type="text" id="movil-asignado" placeholder="Móvil asignado" required>
<select id="estado-movil" required>
<option value="">Estado</option>
<option value="Disponible">Disponible</option>
<option value="En servicio">En servicio</option>
<option value="En mantenimiento">En mantenimiento</option>
</select>
<textarea id="observaciones" placeholder="Observaciones"></textarea>
<button type="submit"><i class="fas fa-sign-out-alt"></i> Registrar</button>
</form>
</div>

<div class="container tab-content hidden" id="historial">
<h2>Historial</h2>
<input type="month" id="filtro-fecha-historial">
<table>
<thead>
<tr><th>Fecha</th><th>Actividad</th><th>Ingreso</th><th>Salida</th><th>Horas</th><th>Estado</th></tr>
</thead>
<tbody id="historial-table-body"></tbody>
</table>
</div>
</div>

<!-- PANEL ADMIN -->
<div id="admin-system" class="hidden">
<header>
<span>Admin</span>
<button id="logout-admin"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
</header>
<nav>
<a href="#admin-dashboard" class="nav-link active">Dashboard</a>
<a href="#admin-users" class="nav-link">Agregar Usuarios</a>
<a href="#admin-historial" class="nav-link">Historial General</a>
<a href="#admin-actividades" class="nav-link">Gestionar Actividades</a>
</nav>

<div class="container tab-content" id="admin-dashboard">
<h2>Dashboard Admin</h2>
<p style="text-align:center;">Bienvenido, Admin. Desde aquí puedes gestionar usuarios y ver estadísticas.</p>
<div class="dashboard-grid">
<div class="card"><h3>Total Usuarios</h3><div class="value" id="total-usuarios">0</div></div>
<div class="card"><h3>Registros totales</h3><div class="value" id="total-registros">0</div></div>
<div class="card"><h3>Actividades</h3><div class="value" id="total-actividades">0</div></div>
</div>
</div>

<div class="container tab-content hidden" id="admin-users">
<h2>Agregar Usuario</h2>
<form id="add-user-form">
<input type="text" id="new-user-name" placeholder="Nombre" required>
<input type="text" id="new-user-username" placeholder="Usuario" required>
<input type="password" id="new-user-pass" placeholder="Contraseña" required>
<select id="new-user-rango" required>
  <option value="">Selecciona rango</option>
  <option value="Bombero">Bombero</option>
  <option value="Cabo">Cabo</option>
  <option value="Teniente">Teniente</option>
  <option value="Capitán">Capitán</option>
</select>
<button type="submit"><i class="fas fa-user-plus"></i> Agregar Usuario</button>
</form>
<h3 style="margin-top:30px;">Lista de Usuarios</h3>
<table>
<thead>
<tr><th>Nombre</th><th>Usuario</th><th>Rango</th><th>Acción</th></tr>
</thead>
<tbody id="users-table-body"></tbody>
</table>
</div>

<div class="container tab-content hidden" id="admin-historial">
<h2>Historial General de Usuarios</h2>
<input type="month" id="filtro-fecha-admin">
<table>
<thead>
<tr><th>Usuario</th><th>Fecha</th><th>Actividad</th><th>Ingreso</th><th>Salida</th><th>Horas</th><th>Estado</th></tr>
</thead>
<tbody id="historial-general-body"></tbody>
</table>
</div>

<div class="container tab-content hidden" id="admin-actividades">
<h2>Gestionar Actividades</h2>
<form id="add-actividad-form" style="max-width:500px;">
<input type="text" id="new-actividad" placeholder="Nombre de nueva actividad" required>
<button type="submit"><i class="fas fa-plus"></i> Agregar Actividad</button>
</form>
<h3 style="margin-top:30px;">Lista de Actividades</h3>
<table style="max-width:500px;">
<thead>
<tr><th>Actividad</th><th>Acción</th></tr>
</thead>
<tbody id="actividades-table-body"></tbody>
</table>
</div>

</div>

<div id="popup-container"></div>

<script>
// ===========================================
// INICIALIZACIÓN Y DATOS
// ===========================================

// Datos iniciales
let usuarios = JSON.parse(localStorage.getItem('usuariosBomberos')) || [
  {id:1, legajo:"ADMIN", nombre:"Administrador", rango:"Admin", usuario:"admin", password:"admin", admin:true}
];

let registros = JSON.parse(localStorage.getItem('registrosBomberos')) || [];

let actividades = JSON.parse(localStorage.getItem('actividadesBomberos')) || [
  {id:1, nombre:"Patrulla"},
  {id:2, nombre:"Guardia"},
  {id:3, nombre:"Entrenamiento"},
  {id:4, nombre:"Mantenimiento"}
];

let usuarioActual = null;
let horasChart = null;

// ===========================================
// FUNCIONES DE INICIALIZACIÓN
// ===========================================

// Función para guardar datos en localStorage
function guardarDatos() {
  localStorage.setItem('usuariosBomberos', JSON.stringify(usuarios));
  localStorage.setItem('registrosBomberos', JSON.stringify(registros));
  localStorage.setItem('actividadesBomberos', JSON.stringify(actividades));
}

// Inicializar el sistema cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
  const sesion = localStorage.getItem('sesionBomberos');
  if (sesion) {
    usuarioActual = JSON.parse(sesion);
    if (usuarioActual.admin) {
      initAdminSistema();
    } else {
      initSistema();
    }
  }
  
  // Configurar eventos de login
  document.getElementById('login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const user = document.getElementById('login-user').value;
    const pass = document.getElementById('login-password').value;
    const u = usuarios.find(x => x.usuario === user && x.password === pass);
    
    if (u) {
      usuarioActual = u;
      localStorage.setItem('sesionBomberos', JSON.stringify(u));
      if (u.admin) {
        initAdminSistema();
      } else {
        initSistema();
      }
    } else {
      mostrarPopup('Usuario o contraseña incorrectos', 'error');
    }
  });
  
  // Configurar eventos de logout
  document.getElementById('logout-btn').addEventListener('click', function() {
    localStorage.removeItem('sesionBomberos');
    location.reload();
  });
  
  document.getElementById('logout-admin').addEventListener('click', function() {
    localStorage.removeItem('sesionBomberos');
    location.reload();
  });
  
  // Configurar navegación para usuario normal
  document.querySelectorAll('#main-system .nav-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('#main-system .nav-link').forEach(function(l) {
        l.classList.remove('active');
      });
      document.querySelectorAll('#main-system .tab-content').forEach(function(tab) {
        tab.classList.add('hidden');
      });
      
      this.classList.add('active');
      const targetId = this.getAttribute('href').substring(1);
      document.getElementById(targetId).classList.remove('hidden');
      
      if (targetId === 'historial') cargarHistorial();
      if (targetId === 'dashboard') actualizarDashboard();
    });
  });
  
  // Configurar navegación para admin
  document.querySelectorAll('#admin-system .nav-link').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('#admin-system .nav-link').forEach(function(l) {
        l.classList.remove('active');
      });
      document.querySelectorAll('#admin-system .tab-content').forEach(function(tab) {
        tab.classList.add('hidden');
      });
      
      this.classList.add('active');
      const targetId = this.getAttribute('href').substring(1);
      document.getElementById(targetId).classList.remove('hidden');
      
      if (targetId === 'admin-users') cargarUsuarios();
      if (targetId === 'admin-dashboard') actualizarAdminDashboard();
      if (targetId === 'admin-historial') cargarHistorialGeneral();
      if (targetId === 'admin-actividades') cargarActividadesAdmin();
    });
  });
  
  // Configurar formularios
  document.getElementById('ingreso-form').addEventListener('submit', registrarIngreso);
  document.getElementById('salida-form').addEventListener('submit', registrarSalida);
  document.getElementById('add-user-form').addEventListener('submit', agregarUsuario);
  document.getElementById('add-actividad-form').addEventListener('submit', agregarActividad);
  
  // Configurar filtros
  document.getElementById('filtro-fecha-historial').addEventListener('change', cargarHistorial);
  document.getElementById('filtro-fecha-admin').addEventListener('change', cargarHistorialGeneral);
});

// ===========================================
// SISTEMA DE USUARIO NORMAL
// ===========================================

function initSistema() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('main-system').classList.remove('hidden');
  document.getElementById('user-name').textContent = usuarioActual.nombre;
  document.getElementById('user-rank').textContent = usuarioActual.rango;
  document.getElementById('legajo').value = usuarioActual.legajo;
  document.getElementById('legajo-salida').value = usuarioActual.legajo;
  
  cargarActividades();
  actualizarDashboard();
}

function cargarActividades() {
  const select = document.getElementById('actividad');
  select.innerHTML = '<option value="">Selecciona actividad</option>';
  actividades.forEach(function(act) {
    const option = document.createElement('option');
    option.value = act.id;
    option.textContent = act.nombre;
    select.appendChild(option);
  });
}

function registrarIngreso(e) {
  e.preventDefault();
  const actividadId = document.getElementById('actividad').value;
  const observaciones = document.getElementById('observaciones-ingreso').value;
  
  if (!actividadId) {
    mostrarPopup('Selecciona una actividad', 'error');
    return;
  }
  
  // Verificar si ya hay un ingreso pendiente
  const ingresoPendiente = registros.some(function(r) {
    return r.legajo === usuarioActual.legajo && r.salida === '';
  });
  
  if (ingresoPendiente) {
    mostrarPopup('Ya tienes un ingreso pendiente de salida', 'error');
    return;
  }
  
  const fecha = new Date();
  const actividad = actividades.find(function(a) { return a.id == actividadId; });
  
  registros.push({
    legajo: usuarioActual.legajo,
    actividad: actividad.nombre,
    ingreso: fecha.toLocaleTimeString(),
    salida: '',
    horas: 0,
    observaciones: observaciones,
    fecha: fecha.toISOString().split('T')[0],
    timestampIngreso: fecha.getTime()
  });
  
  guardarDatos();
  mostrarPopup('Ingreso registrado correctamente', 'success');
  document.getElementById('ingreso-form').reset();
  document.getElementById('legajo').value = usuarioActual.legajo;
  actualizarDashboard();
}

function registrarSalida(e) {
  e.preventDefault();
  const movil = document.getElementById('movil-asignado').value;
  const estado = document.getElementById('estado-movil').value;
  const observaciones = document.getElementById('observaciones').value;
  
  if (!movil || !estado) {
    mostrarPopup('Completa todos los campos obligatorios', 'error');
    return;
  }
  
  const registro = registros.find(function(r) {
    return r.legajo === usuarioActual.legajo && r.salida === '';
  });
  
  if (!registro) {
    mostrarPopup('No hay ingreso pendiente para registrar salida', 'error');
    return;
  }
  
  const fechaSalida = new Date();
  const fechaIngreso = new Date(registro.timestampIngreso);
  
  // Calcular diferencia en horas (más preciso)
  const diferenciaMs = fechaSalida - fechaIngreso;
  const horasTrabajadas = (diferenciaMs / (1000 * 60 * 60)).toFixed(2);
  
  registro.salida = fechaSalida.toLocaleTimeString();
  registro.horas = parseFloat(horasTrabajadas);
  registro.movil = movil;
  registro.estadoMovil = estado;
  registro.observacionesSalida = observaciones;
  
  guardarDatos();
  mostrarPopup('Salida registrada correctamente', 'success');
  document.getElementById('salida-form').reset();
  document.getElementById('legajo-salida').value = usuarioActual.legajo;
  actualizarDashboard();
  cargarHistorial();
}

function cargarHistorial() {
  const tbody = document.getElementById('historial-table-body');
  tbody.innerHTML = '';
  
  let datos = registros.filter(function(r) {
    return r.legajo === usuarioActual.legajo;
  });
  
  const filtro = document.getElementById('filtro-fecha-historial').value;
  if (filtro) {
    datos = datos.filter(function(r) {
      return r.fecha.startsWith(filtro);
    });
  }
  
  if (datos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay registros para mostrar</td></tr>';
    return;
  }
  
  // Ordenar por fecha (más reciente primero)
  datos.sort(function(a, b) {
    return new Date(b.fecha) - new Date(a.fecha);
  });
  
  datos.forEach(function(r) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.fecha}</td>
      <td>${r.actividad}</td>
      <td>${r.ingreso}</td>
      <td>${r.salida || '-'}</td>
      <td>${r.horas || '-'}</td>
      <td>${r.salida ? '<span class="badge badge-success">Completo</span>' : '<span class="badge badge-warning">Pendiente</span>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function actualizarDashboard() {
  const registrosUsuario = registros.filter(function(r) {
    return r.legajo === usuarioActual.legajo;
  });
  
  const registrosCompletos = registrosUsuario.filter(function(r) {
    return r.salida !== '';
  });
  
  // Calcular horas del mes actual
  const mesActual = new Date().getMonth();
  const anioActual = new Date().getFullYear();
  const horasMes = registrosCompletos
    .filter(function(r) {
      const fechaRegistro = new Date(r.fecha);
      return fechaRegistro.getMonth() === mesActual && fechaRegistro.getFullYear() === anioActual;
    })
    .reduce(function(total, r) {
      return total + r.horas;
    }, 0);
  
  // Días trabajados (únicos)
  const diasTrabajados = new Set(registrosCompletos.map(function(r) { return r.fecha; })).size;
  
  // Promedio de horas por día
  const promedioHoras = diasTrabajados > 0 ? (horasMes / diasTrabajados).toFixed(2) : 0;
  
  document.getElementById('horas-mes').textContent = horasMes.toFixed(2);
  document.getElementById('dias-trabajados').textContent = diasTrabajados;
  document.getElementById('guardias-completadas').textContent = registrosCompletos.length;
  document.getElementById('promedio-horas').textContent = promedioHoras;
  
  const ultima = registrosUsuario.find(function(r) { return r.salida === ''; });
  const estadoActual = document.getElementById('estado-actual');
  
  if (ultima) {
    estadoActual.textContent = `Guardia activa - ${ultima.actividad} desde ${ultima.ingreso}`;
    estadoActual.className = 'alert alert-success';
  } else {
    estadoActual.textContent = 'Sin guardia activa';
    estadoActual.className = 'alert alert-info';
  }
  
  initChart();
}

function initChart() {
  const ctx = document.getElementById('horasChart').getContext('2d');
  
  // Destruir gráfico anterior si existe
  if (horasChart) {
    horasChart.destroy();
  }
  
  // Obtener datos de los últimos 7 días
  const ultimos7Dias = [];
  for (let i = 6; i >= 0; i--) {
    const fecha = new Date();
    fecha.setDate(fecha.getDate() - i);
    ultimos7Dias.push(fecha.toISOString().split('T')[0]);
  }
  
  const datosGrafico = ultimos7Dias.map(function(fecha) {
    const registrosDia = registros.filter(function(r) {
      return r.fecha === fecha && 
             r.legajo === usuarioActual.legajo &&
             r.salida !== '';
    });
    return registrosDia.reduce(function(total, r) {
      return total + r.horas;
    }, 0);
  });
  
  // Formatear fechas para mostrar en el gráfico
  const etiquetas = ultimos7Dias.map(function(fecha) {
    const d = new Date(fecha);
    return `${d.getDate()}/${d.getMonth() + 1}`;
  });
  
  horasChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: etiquetas,
      datasets: [{
        label: 'Horas trabajadas',
        data: datosGrafico,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Horas'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Días'
          }
        }
      }
    }
  });
}

// ===========================================
// SISTEMA ADMINISTRADOR
// ===========================================

function initAdminSistema() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('admin-system').classList.remove('hidden');
  cargarUsuarios();
  actualizarAdminDashboard();
  cargarHistorialGeneral();
  cargarActividadesAdmin();
}

function agregarUsuario(e) {
  e.preventDefault();
  const nombre = document.getElementById('new-user-name').value;
  const usuario = document.getElementById('new-user-username').value;
  const password = document.getElementById('new-user-pass').value;
  const rango = document.getElementById('new-user-rango').value;
  
  if (usuarios.some(function(u) { return u.usuario === usuario; })) {
    mostrarPopup('El nombre de usuario ya existe', 'error');
    return;
  }
  
  const id = usuarios.length > 0 ? Math.max(...usuarios.map(function(u) { return u.id; })) + 1 : 1;
  const legajo = `B${id.toString().padStart(3, '0')}`;
  
  usuarios.push({
    id: id,
    legajo: legajo,
    nombre: nombre,
    rango: rango,
    usuario: usuario,
    password: password,
    admin: false
  });
  
  guardarDatos();
  mostrarPopup('Usuario agregado correctamente', 'success');
  document.getElementById('add-user-form').reset();
  cargarUsuarios();
  actualizarAdminDashboard();
}

function cargarUsuarios() {
  const tbody = document.getElementById('users-table-body');
  tbody.innerHTML = '';
  
  const usuariosNormales = usuarios.filter(function(u) { return !u.admin; });
  
  if (usuariosNormales.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay usuarios registrados</td></tr>';
    return;
  }
  
  usuariosNormales.forEach(function(u) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.nombre}</td>
      <td>${u.usuario}</td>
      <td>${u.rango}</td>
      <td><button onclick="eliminarUsuario(${u.id})" style="background:#ef4444;color:#fff;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function eliminarUsuario(id) {
  if (confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
    usuarios = usuarios.filter(function(u) { return u.id !== id; });
    guardarDatos();
    mostrarPopup('Usuario eliminado correctamente', 'success');
    cargarUsuarios();
    actualizarAdminDashboard();
  }
}

function cargarHistorialGeneral() {
  const tbody = document.getElementById('historial-general-body');
  tbody.innerHTML = '';
  
  let datos = registros;
  
  const filtro = document.getElementById('filtro-fecha-admin').value;
  if (filtro) {
    datos = datos.filter(function(r) {
      return r.fecha.startsWith(filtro);
    });
  }
  
  if (datos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay registros para mostrar</td></tr>';
    return;
  }
  
  // Ordenar por fecha (más reciente primero)
  datos.sort(function(a, b) {
    return new Date(b.fecha) - new Date(a.fecha);
  });
  
  datos.forEach(function(r) {
    const usuario = usuarios.find(function(u) { return u.legajo === r.legajo; });
    const nombreUsuario = usuario ? usuario.nombre : r.legajo;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${nombreUsuario}</td>
      <td>${r.fecha}</td>
      <td>${r.actividad}</td>
      <td>${r.ingreso}</td>
      <td>${r.salida || '-'}</td>
      <td>${r.horas || '-'}</td>
      <td>${r.salida ? '<span class="badge badge-success">Completo</span>' : '<span class="badge badge-warning">Pendiente</span>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function agregarActividad(e) {
  e.preventDefault();
  const nombre = document.getElementById('new-actividad').value;
  
  if (actividades.some(function(a) { return a.nombre.toLowerCase() === nombre.toLowerCase(); })) {
    mostrarPopup('Esta actividad ya existe', 'error');
    return;
  }
  
  const id = actividades.length > 0 ? Math.max(...actividades.map(function(a) { return a.id; })) + 1 : 1;
  
  actividades.push({
    id: id,
    nombre: nombre
  });
  
  guardarDatos();
  mostrarPopup('Actividad agregada correctamente', 'success');
  document.getElementById('add-actividad-form').reset();
  cargarActividadesAdmin();
  cargarActividades(); // Actualizar también en el sistema de usuario
}

function cargarActividadesAdmin() {
  const tbody = document.getElementById('actividades-table-body');
  tbody.innerHTML = '';
  
  if (actividades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">No hay actividades registradas</td></tr>';
    return;
  }
  
  actividades.forEach(function(a) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.nombre}</td>
      <td><button onclick="eliminarActividad(${a.id})" style="background:#ef4444;color:#fff;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function eliminarActividad(id) {
  if (actividades.length <= 1) {
    mostrarPopup('Debe haber al menos una actividad', 'error');
    return;
  }
  
  if (confirm('¿Estás seguro de que deseas eliminar esta actividad?')) {
    actividades = actividades.filter(function(a) { return a.id !== id; });
    guardarDatos();
    mostrarPopup('Actividad eliminada correctamente', 'success');
    cargarActividadesAdmin();
    cargarActividades(); // Actualizar también en el sistema de usuario
  }
}

function actualizarAdminDashboard() {
  document.getElementById('total-usuarios').textContent = usuarios.filter(function(u) { return !u.admin; }).length;
  document.getElementById('total-registros').textContent = registros.length;
  document.getElementById('total-actividades').textContent = actividades.length;
}

// ===========================================
// FUNCIONES GENERALES
// ===========================================

function mostrarPopup(mensaje, tipo) {
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.textContent = mensaje;
  
  if (tipo === 'success') {
    popup.style.background = '#34d399';
  } else if (tipo === 'error') {
    popup.style.background = '#f87171';
  } else {
    popup.style.background = '#60a5fa';
  }
  
  document.getElementById('popup-container').appendChild(popup);
  setTimeout(function() {
    popup.remove();
  }, 3000);
}
</script>
</body>
</html>
