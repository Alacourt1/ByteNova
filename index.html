<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bomberos — Sistema (Minimal)</title>

<!-- Iconos FontAwesome -->
<script src="https://kit.fontawesome.com/a2e0b6c15a.js" crossorigin="anonymous"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f7f8fa;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0f62fe; /* azul */
    --danger:#ef4444;
    --success:#10b981;
    --glass: rgba(15,98,254,0.06);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--bg);
    color:#111827;
    -webkit-font-smoothing:antialiased;
    padding:18px;
  }

  /* Contenedor */
  .wrap{
    max-width:1100px;
    margin:0 auto;
  }

  /* Header */
  header.appbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:18px;
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .brand h1{font-size:18px; font-weight:600;}
  .brand p{color:var(--muted); font-size:13px; margin-top:2px;}

  /* Simple top actions */
  .top-actions{display:flex; gap:8px; align-items:center;}
  .btn{
    background:var(--accent);
    color:white;
    border:none;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    font-size:13px;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid rgba(15,98,254,0.12);
  }
  .btn.warn{background:var(--danger)}
  .btn.small{padding:6px 8px; font-size:12px; border-radius:6px}

  /* Layout con nav lateral simple (minimal) */
  .main{
    display:grid;
    grid-template-columns: 260px 1fr;
    gap:18px;
  }

  nav.sidebar{
    background:var(--card);
    border-radius:10px;
    padding:12px;
    border:1px solid #eef2ff;
    height:calc(100vh - 140px);
    position:sticky;
    top:20px;
  }
  nav a{
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:8px;
    color:var(--muted);
    text-decoration:none;
    margin-bottom:6px;
    font-weight:600;
    font-size:14px;
    position: relative;
  }
  nav a.active{background:var(--glass); color:var(--accent)}

  /* Contenido principal */
  .panel{
    background:transparent;
  }
  .card{
    background:var(--card);
    border-radius:10px;
    padding:16px;
    margin-bottom:12px;
    border:1px solid rgba(2,6,23,0.04);
  }

  /* minimal forms */
  form input, form select, form textarea {
    width:100%;
    padding:10px 12px;
    border:1px solid #e6edf8;
    border-radius:8px;
    font-size:14px;
    margin-top:8px;
    background:transparent;
  }
  label{font-size:13px; color:var(--muted); display:block; margin-top:8px}
  form .row{display:flex; gap:8px;}
  .row .col{flex:1}

  /* tabla compacta */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  th,td{padding:10px; text-align:left; border-bottom:1px solid #f1f5f9}
  th{font-weight:700; color:var(--muted); font-size:13px}

  .muted{color:var(--muted); font-size:13px}
  .value-large{font-size:20px; font-weight:700; color:var(--accent)}

  /* badges */
  .badge{
    display:inline-block; padding:6px 8px; border-radius:6px; font-size:12px; font-weight:700;
  }
  .badge.success{background:rgba(16,185,129,0.12); color:var(--success)}
  .badge.warn{background:rgba(245,158,11,0.08); color:#b45309}
  .badge.info{background:rgba(15,98,254,0.08); color:var(--accent)}
  .badge.notification {
    position: absolute;
    right: 10px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
  }

  /* popup (simple) */
  .popup{
    position:fixed; right:18px; bottom:18px;
    background:#111827; color:white; padding:10px 14px; border-radius:10px; z-index:999;
    box-shadow:0 6px 18px rgba(2,6,23,0.08);
  }

  /* Novedades */
  .novedad-card {
    background: var(--card);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid rgba(2,6,23,0.04);
    position: relative;
  }
  .novedad-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }
  .novedad-titulo {
    font-weight: 600;
    font-size: 16px;
    color: #111827;
  }
  .novedad-fecha {
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap;
  }
  .novedad-contenido {
    color: #374151;
    font-size: 14px;
    line-height: 1.5;
  }
  .novedad-eliminar {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 14px;
  }
  .novedad-eliminar:hover {
    color: var(--danger);
  }

  /* responsive */
  @media (max-width:900px){
    .main{grid-template-columns:1fr; }
    nav.sidebar{height:auto; position:relative}
  }
</style>
</head>
<body>
  <div class="wrap">

    <header class="appbar">
      <div class="brand">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" style="border-radius:8px;background:linear-gradient(180deg,#e6f2ff,#ffffff);padding:6px">
          <path d="M12 2L3 7v5c0 5 3 9 9 10 6-1 9-5 9-10V7l-9-5z" fill="#0f62fe"></path>
        </svg>
        <div>
          <h1>Bomberos — Control de Guardias</h1>
          <p class="muted">Minimal · local (sin servidor) · listo para pruebas</p>
        </div>
      </div>

      <div class="top-actions">
        <div id="session-info" class="muted">No conectado</div>
        <button class="btn ghost small" id="btn-export">Exportar CSV</button>
        <button class="btn warn small" id="logout-top" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="login-screen" class="card">
      <h2 style="margin-bottom:8px">Iniciar sesión</h2>
      <p class="muted" style="margin-bottom:8px">Usa el admin por defecto: <strong>admin / admin</strong> (cámbialo luego)</p>
      <form id="login-form" autocomplete="off">
        <label for="login-user">Usuario</label>
        <input id="login-user" aria-label="Usuario" required />
        <label for="login-password">Contraseña</label>
        <input id="login-password" type="password" aria-label="Contraseña" required />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" type="submit"><i class="fas fa-sign-in-alt"></i>&nbsp;Ingresar</button>
          <button id="demo-user" type="button" class="btn ghost small">Ingresar demo</button>
        </div>
      </form>
      <div id="login-error" class="muted" style="margin-top:10px;color:var(--danger);display:none"></div>
    </div>

    <!-- APP (visible cuando logueado) -->
    <div id="app" class="main" style="display:none">
      <nav class="sidebar" aria-label="Navegación principal">
        <!-- Menú para usuarios regulares -->
        <div class="user-only">
          <a href="#dashboard" class="nav-link active"><i class="fas fa-chart-bar"></i> Dashboard</a>
          <a href="#ingreso" class="nav-link"><i class="fas fa-sign-in-alt"></i> Registrar ingreso</a>
          <a href="#salida" class="nav-link"><i class="fas fa-sign-out-alt"></i> Registrar salida</a>
          <a href="#historial" class="nav-link"><i class="fas fa-history"></i> Historial personal</a>
          <a href="#novedades" class="nav-link" id="novedades-link">
            <i class="fas fa-bullhorn"></i> Novedades
            <span class="badge notification" id="novedades-badge" style="display:none">0</span>
          </a>
        </div>
        
        <!-- Menú para administradores -->
        <div class="admin-only">
          <hr style="border:none;height:8px;margin:12px 0">
          <a href="#admin-dashboard" class="nav-link"><i class="fas fa-cog"></i> Panel de Control</a>
          <a href="#admin-users" class="nav-link"><i class="fas fa-users"></i> Gestión de Usuarios</a>
          <a href="#admin-actividades" class="nav-link"><i class="fas fa-list"></i> Actividades</a>
          <a href="#admin-novedades" class="nav-link"><i class="fas fa-bullhorn"></i> Gestión de Novedades</a>
        </div>
      </nav>

      <main class="panel">
        <!-- DASHBOARD -->
        <section id="dashboard" class="tab card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 style="margin-bottom:6px">Dashboard</h3>
              <div class="muted">Resumen rápido</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Usuario:</div>
              <div id="user-title" class="value-large">—</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:14px">
            <div class="card" style="padding:12px">
              <div class="muted">Horas este mes</div>
              <div id="horas-mes" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Días trabajados</div>
              <div id="dias-trabajados" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Guardias completadas</div>
              <div id="guardias-completadas" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Promedio horas/día</div>
              <div id="promedio-horas" class="value-large">0</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <canvas id="horasChart" height="90"></canvas>
          </div>
        </section>

        <!-- INGRESO -->
        <section id="ingreso" class="tab card" style="display:none">
          <h3>Registrar ingreso</h3>
          <form id="ingreso-form">
            <label>Legajo</label>
            <input id="legajo" readonly />
            <label>Actividad</label>
            <select id="actividad" required aria-label="Actividad"></select>
            <label>Observaciones</label>
            <textarea id="observaciones-ingreso" rows="3"></textarea>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" type="submit"><i class="fas fa-sign-in-alt"></i>&nbsp;Registrar</button>
              <button id="clear-ingreso" type="button" class="btn ghost small">Limpiar</button>
            </div>
          </form>
        </section>

        <!-- SALIDA -->
        <section id="salida" class="tab card" style="display:none">
          <h3>Registrar salida</h3>
          <form id="salida-form">
            <label>Legajo</label>
            <input id="legajo-salida" readonly />
            <div class="row">
              <div class="col">
                <label>Móvil asignado</label>
                <input id="movil-asignado" required />
              </div>
              <div class="col">
                <label>Estado del móvil</label>
                <select id="estado-movil" required>
                  <option value="">Seleccione</option>
                  <option>Disponible</option>
                  <option>En servicio</option>
                  <option>En mantenimiento</option>
                </select>
              </div>
            </div>
            <label>Observaciones</label>
            <textarea id="observaciones" rows="3"></textarea>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" type="submit"><i class="fas fa-sign-out-alt"></i>&nbsp;Registrar salida</button>
              <button id="clear-salida" type="button" class="btn ghost small">Limpiar</button>
            </div>
          </form>
        </section>

        <!-- HISTORIAL PERSONAL -->
        <section id="historial" class="tab card" style="display:none">
          <h3>Historial</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input type="month" id="filtro-fecha-historial" style="max-width:190px" />
            <div style="flex:1"></div>
            <div id="estado-actual" class="badge info">Sin guardia activa</div>
          </div>

          <table>
            <thead><tr><th>Fecha</th><th>Actividad</th><th>Ingreso</th><th>Salida</th><th>Horas</th><th>Estado</th></tr></thead>
            <tbody id="historial-table-body"></tbody>
          </table>
        </section>

        <!-- NOVEDADES -->
        <section id="novedades" class="tab card" style="display:none">
          <h3>Novedades</h3>
          <p class="muted" style="margin-bottom:16px">Información importante y anuncios recientes</p>
          <div id="novedades-container"></div>
        </section>

        <!-- ADMIN: DASHBOARD -->
        <section id="admin-dashboard" class="tab card" style="display:none">
          <h3>Panel de Control - Administración</h3>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div class="card" style="padding:12px">
              <div class="muted">Total usuarios</div>
              <div id="total-usuarios" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Registros totales</div>
              <div id="total-registros" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Actividades</div>
              <div id="total-actividades" class="value-large">0</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Novedades</div>
              <div id="total-novedades" class="value-large">0</div>
            </div>
          </div>
        </section>

        <!-- ADMIN: USUARIOS -->
        <section id="admin-users" class="tab card" style="display:none">
          <h3>Gestión de Usuarios</h3>

          <form id="add-user-form" style="max-width:520px">
            <div class="row">
              <div class="col">
                <label>Nombre</label>
                <input id="new-user-name" required />
              </div>
              <div class="col">
                <label>Usuario</label>
                <input id="new-user-username" required />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label>Contraseña</label>
                <input id="new-user-pass" type="password" required />
              </div>
              <div class="col">
                <label>Rango</label>
                <select id="new-user-rango" required>
                  <option value="">Seleccionar</option>
                  <option>Bombero</option>
                  <option>Cabo</option>
                  <option>Teniente</option>
                  <option>Capitán</option>
                </select>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <button class="btn" type="submit"><i class="fas fa-user-plus"></i>&nbsp;Agregar</button>
              <button id="toggle-pass" type="button" class="btn ghost small">Mostrar contraseña</button>
              <div style="flex:1"></div>
              <input id="search-users" placeholder="Buscar usuarios..." style="max-width:220px;padding:8px;border-radius:8px;border:1px solid #eef2ff" />
            </div>
          </form>

          <div style="margin-top:12px">
            <table>
              <thead><tr><th>Nombre</th><th>Usuario</th><th>Rango</th><th>Acción</th></tr></thead>
              <tbody id="users-table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- ADMIN: ACTIVIDADES -->
        <section id="admin-actividades" class="tab card" style="display:none">
          <h3>Gestión de Actividades</h3>

          <form id="add-actividad-form" style="max-width:520px">
            <div style="display:flex;gap:8px">
              <input id="new-actividad" placeholder="Nombre de la actividad" required />
              <button class="btn" type="submit"><i class="fas fa-plus"></i>&nbsp;Agregar</button>
            </div>
          </form>

          <div style="margin-top:12px">
            <table style="max-width:500px">
              <thead><tr><th>Actividad</th><th>Acción</th></tr></thead>
              <tbody id="actividades-table-body"></tbody>
            </table>
          </div>
        </section>

        <!-- ADMIN: NOVEDADES -->
        <section id="admin-novedades" class="tab card" style="display:none">
          <h3>Gestión de Novedades</h3>
          <p class="muted" style="margin-bottom:16px">Crear y gestionar novedades para todos los usuarios</p>

          <form id="add-novedad-form" style="max-width:600px; margin-bottom: 20px;">
            <label>Título de la novedad</label>
            <input id="novedad-titulo" required placeholder="Ingrese el título de la novedad" />
            
            <label>Contenido</label>
            <textarea id="novedad-contenido" rows="4" required placeholder="Escriba el contenido de la novedad"></textarea>
            
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" type="submit"><i class="fas fa-plus"></i>&nbsp;Publicar Novedad</button>
              <button type="button" class="btn ghost small" onclick="document.getElementById('add-novedad-form').reset()">Limpiar</button>
            </div>
          </form>

          <h4 style="margin-top: 20px; margin-bottom: 12px;">Novedades publicadas</h4>
          <div id="admin-novedades-container"></div>
        </section>

      </main>
    </div>

    <div id="popup-container"></div>

  </div>

<script>
/* ===========================
   Datos iniciales y utilidades
   =========================== */
const STORAGE = {
  USERS: 'usuariosBomberos_v2',
  REGS: 'registrosBomberos_v2',
  ACTS: 'actividadesBomberos_v2',
  SESSION: 'sesionBomberos_v2',
  NOVEDADES: 'novedadesBomberos_v2'
};

let usuarios = JSON.parse(localStorage.getItem(STORAGE.USERS)) || [
  // usuario admin por defecto para pruebas (cambiar después)
  { id: 1, legajo: 'ADMIN', nombre: 'Administrador', rango: 'Admin', usuario: 'admin', password: 'admin', admin: true }
];

let registros = JSON.parse(localStorage.getItem(STORAGE.REGS)) || [];
let actividades = JSON.parse(localStorage.getItem(STORAGE.ACTS)) || [
  { id: 1, nombre: 'Patrulla' },
  { id: 2, nombre: 'Guardia' },
  { id: 3, nombre: 'Entrenamiento' },
  { id: 4, nombre: 'Mantenimiento' }
];

let novedades = JSON.parse(localStorage.getItem(STORAGE.NOVEDADES)) || [
  { id: 1, titulo: 'Bienvenidos al Sistema', contenido: 'Este es el sistema de control de guardias para el cuerpo de bomberos. Por favor, registren sus ingresos y salidas correctamente.', fecha: new Date().toISOString().split('T')[0], autor: 'Administrador' }
];

let usuarioActual = null;
let horasChart = null;

/* Guardar datos */
function guardarDatos(){
  localStorage.setItem(STORAGE.USERS, JSON.stringify(usuarios));
  localStorage.setItem(STORAGE.REGS, JSON.stringify(registros));
  localStorage.setItem(STORAGE.ACTS, JSON.stringify(actividades));
  localStorage.setItem(STORAGE.NOVEDADES, JSON.stringify(novedades));
}

/* Popup simple */
function mostrarPopup(txt, type='info'){
  const el = document.createElement('div');
  el.className = 'popup';
  el.textContent = txt;
  if(type==='error') el.style.background = '#ef4444';
  if(type==='success') el.style.background = '#10b981';
  document.getElementById('popup-container').appendChild(el);
  setTimeout(()=> el.remove(), 2500);
}

/* ===========================
   Inicialización DOM
   =========================== */
document.addEventListener('DOMContentLoaded', () => {
  // restaurar sesión
  const s = localStorage.getItem(STORAGE.SESSION);
  if(s){
    try{
      usuarioActual = JSON.parse(s);
      abrirAppSegunRol();
    }catch(e){ console.warn('sesion no valida') }
  }

  // eventos login
  document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    const u = document.getElementById('login-user').value.trim();
    const p = document.getElementById('login-password').value;
    const found = usuarios.find(x => x.usuario === u && x.password === p);
    if(found){
      usuarioActual = found;
      localStorage.setItem(STORAGE.SESSION, JSON.stringify(found));
      abrirAppSegunRol();
      mostrarPopup('Bienvenido ' + found.nombre, 'success');
    } else {
      document.getElementById('login-error').style.display='block';
      document.getElementById('login-error').textContent = 'Usuario o contraseña incorrectos';
      setTimeout(()=> document.getElementById('login-error').style.display='none', 3000);
    }
  });

  // demo quick login (crea un usuario demo si no existe)
  document.getElementById('demo-user').addEventListener('click', () => {
    let demo = usuarios.find(u=> u.usuario==='demo');
    if(!demo){
      const id = usuarios.length ? Math.max(...usuarios.map(x=>x.id)) + 1 : 2;
      demo = { id, legajo:`B${id.toString().padStart(3,'0')}`, nombre:'Usuario Demo', rango:'Bombero', usuario:'demo', password:'demo', admin:false};
      usuarios.push(demo);
      guardarDatos();
    }
    document.getElementById('login-user').value = 'demo';
    document.getElementById('login-password').value = 'demo';
    document.getElementById('login-form').dispatchEvent(new Event('submit'));
  });

  // export CSV
  document.getElementById('btn-export').addEventListener('click', exportarCSV);

  // logout top
  document.getElementById('logout-top').addEventListener('click', () => {
    localStorage.removeItem(STORAGE.SESSION);
    location.reload();
  });

  // navigation links
  document.querySelectorAll('.nav-link').forEach(link=>{
    link.addEventListener('click', e=>{
      e.preventDefault();
      // ocultar todas las tabs
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      // remover active en nav
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      link.classList.add('active');
      const id = link.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if(el) el.style.display = 'block';

      // acciones on open
      if(id === 'historial') cargarHistorial();
      if(id === 'dashboard') actualizarDashboard();
      if(id === 'admin-users') cargarUsuarios();
      if(id === 'admin-actividades') cargarActividadesAdmin();
      if(id === 'admin-dashboard') actualizarAdminDashboard();
      if(id === 'novedades') {
        cargarNovedades();
        // Resetear notificaciones cuando el usuario visita la sección de novedades
        if (!usuarioActual.admin) {
          document.getElementById('novedades-badge').style.display = 'none';
        }
      }
      if(id === 'admin-novedades') cargarNovedadesAdmin();
    });
  });

  // forms
  document.getElementById('ingreso-form').addEventListener('submit', registrarIngreso);
  document.getElementById('salida-form').addEventListener('submit', registrarSalida);
  document.getElementById('add-user-form').addEventListener('submit', agregarUsuario);
  document.getElementById('add-actividad-form').addEventListener('submit', agregarActividad);
  document.getElementById('add-novedad-form').addEventListener('submit', agregarNovedad);

  // otros controles
  document.getElementById('filtro-fecha-historial').addEventListener('change', cargarHistorial);
  document.getElementById('clear-ingreso').addEventListener('click', ()=> document.getElementById('ingreso-form').reset());
  document.getElementById('clear-salida').addEventListener('click', ()=> document.getElementById('salida-form').reset());
  document.getElementById('toggle-pass').addEventListener('click', toggleMostrarPass);
  document.getElementById('search-users').addEventListener('input', cargarUsuarios);

  // inicializar selects/actividades
  cargarActividades();
});

/* ===========================
   Abrir app segun rol
   =========================== */
function abrirAppSegunRol(){
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'grid';
  document.getElementById('user-title').textContent = usuarioActual.nombre + ' · ' + usuarioActual.rango;
  document.getElementById('session-info').textContent = usuarioActual.nombre;

  // rellenar datos de legajo
  document.getElementById('legajo').value = usuarioActual.legajo || '';
  document.getElementById('legajo-salida').value = usuarioActual.legajo || '';

  // mostrar/ocultar opciones según rol
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = usuarioActual.admin ? 'block' : 'none';
  });
  
  document.querySelectorAll('.user-only').forEach(el=>{
    el.style.display = usuarioActual.admin ? 'none' : 'block';
  });

  // por defecto abrir dashboard
  document.querySelectorAll('.tab').forEach(t=> t.style.display='none');
  
  if (usuarioActual.admin) {
    document.getElementById('admin-dashboard').style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    document.querySelector('a[href="#admin-dashboard"]').classList.add('active');
  } else {
    document.getElementById('dashboard').style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    document.querySelector('a[href="#dashboard"]').classList.add('active');
  }

  actualizarDashboard();
  cargarActividades();
  actualizarAdminDashboard();
  
  // Actualizar notificación de novedades para usuarios regulares
  if (!usuarioActual.admin) {
    actualizarNotificacionNovedades();
  }
}

/* ===========================
   Actividades
   =========================== */
function cargarActividades(){
  const sel = document.getElementById('actividad');
  sel.innerHTML = '<option value="">Selecciona actividad</option>';
  actividades.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = a.nombre;
    sel.appendChild(opt);
  });
}

function agregarActividad(e){
  e.preventDefault();
  const nombre = document.getElementById('new-actividad').value.trim();
  if(!nombre){ mostrarPopup('Ingrese nombre de actividad','error'); return; }
  if(actividades.some(a => a.nombre.toLowerCase() === nombre.toLowerCase())){
    mostrarPopup('Actividad ya existente','error'); return;
  }
  const id = actividades.length ? Math.max(...actividades.map(a=>a.id)) + 1 : 1;
  actividades.push({id, nombre});
  guardarDatos();
  mostrarPopup('Actividad agregada','success');
  document.getElementById('add-actividad-form').reset();
  cargarActividadesAdmin();
  cargarActividades();
}

function cargarActividadesAdmin(){
  const tbody = document.getElementById('actividades-table-body');
  tbody.innerHTML = '';
  actividades.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.nombre}</td>
      <td><button class="btn ghost small" onclick="confirmEliminarActividad(${a.id})"><i class="fas fa-trash"></i>&nbsp;Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}

function confirmEliminarActividad(id){
  if(actividades.length <= 1){ mostrarPopup('Debe quedar al menos una actividad','error'); return; }
  if(confirm('Eliminar actividad?')) eliminarActividad(id);
}

function eliminarActividad(id){
  actividades = actividades.filter(a => a.id !== id);
  guardarDatos();
  cargarActividadesAdmin();
  cargarActividades();
  mostrarPopup('Actividad eliminada','success');
}

/* ===========================
   Usuarios (admin)
   =========================== */
function toggleMostrarPass(){
  const p = document.getElementById('new-user-pass');
  const btn = document.getElementById('toggle-pass');
  if(p.type === 'password'){ p.type = 'text'; btn.textContent = 'Ocultar contraseña'; }
  else { p.type = 'password'; btn.textContent = 'Mostrar contraseña'; }
}

function agregarUsuario(e){
  e.preventDefault();
  const nombre = document.getElementById('new-user-name').value.trim();
  const usuario = document.getElementById('new-user-username').value.trim();
  const password = document.getElementById('new-user-pass').value;
  const rango = document.getElementById('new-user-rango').value;

  if(!nombre || !usuario || !password || !rango){ mostrarPopup('Complete todos los campos','error'); return; }
  if(usuarios.some(u => u.usuario === usuario)){ mostrarPopup('Usuario ya existe','error'); return; }

  const id = usuarios.length ? Math.max(...usuarios.map(u=>u.id)) + 1 : 2;
  const legajo = `B${id.toString().padStart(3,'0')}`;
  usuarios.push({ id, legajo, nombre, rango, usuario, password, admin:false });
  guardarDatos();
  mostrarPopup('Usuario agregado','success');
  document.getElementById('add-user-form').reset();
  cargarUsuarios();
  actualizarAdminDashboard();
}

function cargarUsuarios(){
  const term = document.getElementById('search-users').value?.toLowerCase() || '';
  const tbody = document.getElementById('users-table-body');
  tbody.innerHTML = '';
  const usuariosNormales = usuarios.filter(u=> !u.admin && 
    (u.nombre.toLowerCase().includes(term) || u.usuario.toLowerCase().includes(term) || u.rango.toLowerCase().includes(term)));
  if(usuariosNormales.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted)">Sin usuarios</td></tr>';
    return;
  }
  usuariosNormales.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.nombre}</td><td>${u.usuario}</td><td>${u.rango}</td>
      <td>
        <button class="btn ghost small" onclick="resetClave(${u.id})"><i class="fas fa-key"></i>&nbsp;Reset</button>
        <button class="btn ghost small" onclick="confirmEliminarUsuario(${u.id})" style="margin-left:6px"><i class="fas fa-trash"></i>&nbsp;Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function resetClave(id){
  if(!confirm('Resetear contraseña a "demo"?')) return;
  const u = usuarios.find(x=>x.id===id);
  if(u){ u.password = 'demo'; guardarDatos(); mostrarPopup('Contraseña reseteada a "demo"','success'); }
}

function confirmEliminarUsuario(id){
  if(confirm('¿Eliminar usuario? Esta acción es irreversible.')){
    usuarios = usuarios.filter(u => u.id !== id);
    guardarDatos();
    cargarUsuarios();
    actualizarAdminDashboard();
    mostrarPopup('Usuario eliminado','success');
  }
}

/* ===========================
   Ingresos / Salidas (usuario)
   =========================== */
function registrarIngreso(e){
  e.preventDefault();
  const actividadId = document.getElementById('actividad').value;
  const observaciones = document.getElementById('observaciones-ingreso').value.trim();

  if(!actividadId){ mostrarPopup('Selecciona una actividad','error'); return; }

  // Verificar ingreso pendiente
  const pendiente = registros.some(r => r.legajo === usuarioActual.legajo && !r.salida);
  if(pendiente){ mostrarPopup('Tienes ingreso pendiente','error'); return; }

  const fecha = new Date();
  const actividad = actividades.find(a => a.id == actividadId);
  registros.push({
    legajo: usuarioActual.legajo,
    actividad: actividad ? actividad.nombre : '—',
    ingreso: fecha.toLocaleTimeString(),
    salida: '',
    horas: 0,
    observaciones: observaciones,
    fecha: fecha.toISOString().split('T')[0],
    timestampIngreso: fecha.getTime()
  });
  guardarDatos();
  mostrarPopup('Ingreso registrado','success');
  document.getElementById('ingreso-form').reset();
  document.getElementById('legajo').value = usuarioActual.legajo;
  actualizarDashboard();
}

function registrarSalida(e){
  e.preventDefault();
  const movil = document.getElementById('movil-asignado').value.trim();
  const estado = document.getElementById('estado-movil').value;
  const observ = document.getElementById('observaciones').value.trim();

  if(!movil || !estado){ mostrarPopup('Complete los campos','error'); return; }

  const registro = registros.find(r => r.legajo === usuarioActual.legajo && !r.salida);
  if(!registro){ mostrarPopup('No hay ingreso pendiente','error'); return; }

  const fechaSalida = new Date();
  const fechaIngreso = new Date(registro.timestampIngreso || Date.now());
  const diffMs = fechaSalida - fechaIngreso;
  const horas = parseFloat((diffMs / (1000*60*60)).toFixed(2));

  registro.salida = fechaSalida.toLocaleTimeString();
  registro.horas = horas || 0;
  registro.movil = movil;
  registro.estadoMovil = estado;
  registro.observacionesSalida = observ;

  guardarDatos();
  mostrarPopup('Salida registrada','success');
  document.getElementById('salida-form').reset();
  document.getElementById('legajo-salida').value = usuarioActual.legajo;
  actualizarDashboard();
  cargarHistorial();
}

/* ===========================
   Historial y dashboard
   =========================== */
function cargarHistorial(){
  const tbody = document.getElementById('historial-table-body');
  tbody.innerHTML = '';

  let datos = registros.filter(r => r.legajo === usuarioActual.legajo);
  const filtro = document.getElementById('filtro-fecha-historial').value;
  if(filtro){
    datos = datos.filter(r => r.fecha.startsWith(filtro));
  }

  if(datos.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted)">No hay registros</td></tr>';
    return;
  }

  datos.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
  datos.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.fecha}</td>
      <td>${r.actividad}</td>
      <td>${r.ingreso}</td>
      <td>${r.salida || '-'}</td>
      <td>${r.horas || '-'}</td>
      <td>${r.salida ? '<span class="badge success">Completo</span>' : '<span class="badge warn">Pendiente</span>'}</td>`;
    tbody.appendChild(tr);
  });
}

function actualizarDashboard(){
  // seguridad: si no hay usuario actual no hacer nada
  if(!usuarioActual) return;

  const registrosUsuario = registros.filter(r => r.legajo === usuarioActual.legajo);
  const registrosCompletos = registrosUsuario.filter(r => r.salida);

  // horas mes actual
  const hoy = new Date();
  const mes = hoy.getMonth();
  const anio = hoy.getFullYear();
  const horasMes = registrosCompletos
    .filter(r => {
      const fr = new Date(r.fecha);
      return fr.getMonth() === mes && fr.getFullYear() === anio;
    })
    .reduce((s,r) => s + (parseFloat(r.horas) || 0), 0);

  const diasTrabajados = new Set(registrosCompletos.map(r => r.fecha)).size;
  const promedio = diasTrabajados ? (horasMes / diasTrabajados).toFixed(2) : 0;

  document.getElementById('horas-mes').textContent = horasMes.toFixed(2);
  document.getElementById('dias-trabajados').textContent = diasTrabajados;
  document.getElementById('guardias-completadas').textContent = registrosCompletos.length;
  document.getElementById('promedio-horas').textContent = promedio;

  const ultima = registrosUsuario.find(r => !r.salida);
  const estadoEl = document.getElementById('estado-actual');
  if(ultima){
    estadoEl.textContent = `Guardia activa — ${ultima.actividad} desde ${ultima.ingreso}`;
    estadoEl.className = 'badge success';
  } else {
    estadoEl.textContent = 'Sin guardia activa';
    estadoEl.className = 'badge info';
  }

  // Chart
  initChart();
}

/* Chart: últimas 7 fechas (por día) */
function initChart(){
  const ctx = document.getElementById('horasChart').getContext('2d');
  if(horasChart) horasChart.destroy();

  const ult7 = [];
  for(let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(d.getDate()-i);
    ult7.push(d.toISOString().split('T')[0]);
  }

  const data = ult7.map(fecha => {
    return registros
      .filter(r => r.fecha === fecha && r.legajo === usuarioActual.legajo && r.salida)
      .reduce((s,r)=> s + (parseFloat(r.horas)||0), 0);
  });

  const labels = ult7.map(f=>{
    const d = new Date(f); return `${d.getDate()}/${d.getMonth()+1}`;
  });

  horasChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Horas', data, backgroundColor: 'rgba(15,98,254,0.18)', borderColor: 'rgba(15,98,254,0.6)', borderWidth:1 }]},
    options: {
      responsive:true,
      scales:{ y: { beginAtZero:true, title:{display:true,text:'Horas'}}, x:{ title:{display:true,text:'Día'} } },
      plugins: { legend:{ display:false } }
    }
  });
}

/* ===========================
   Novedades
   =========================== */
function cargarNovedades(){
  const container = document.getElementById('novedades-container');
  container.innerHTML = '';
  
  if(novedades.length === 0){
    container.innerHTML = '<p class="muted" style="text-align:center;padding:20px">No hay novedades publicadas</p>';
    return;
  }
  
  // Ordenar novedades por fecha (más recientes primero)
  const novedadesOrdenadas = [...novedades].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  
  novedadesOrdenadas.forEach(novedad => {
    const card = document.createElement('div');
    card.className = 'novedad-card';
    
    const fechaFormateada = new Date(novedad.fecha).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    card.innerHTML = `
      <div class="novedad-header">
        <div class="novedad-titulo">${novedad.titulo}</div>
        <div class="novedad-fecha">${fechaFormateada}</div>
      </div>
      <div class="novedad-contenido">${novedad.contenido}</div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Publicado por: ${novedad.autor}</div>
    `;
    
    container.appendChild(card);
  });
}

function cargarNovedadesAdmin(){
  const container = document.getElementById('admin-novedades-container');
  container.innerHTML = '';
  
  if(novedades.length === 0){
    container.innerHTML = '<p class="muted" style="text-align:center;padding:20px">No hay novedades publicadas</p>';
    return;
  }
  
  // Ordenar novedades por fecha (más recientes primero)
  const novedadesOrdenadas = [...novedades].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  
  novedadesOrdenadas.forEach(novedad => {
    const card = document.createElement('div');
    card.className = 'novedad-card';
    
    const fechaFormateada = new Date(novedad.fecha).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    card.innerHTML = `
      <div class="novedad-header">
        <div class="novedad-titulo">${novedad.titulo}</div>
        <div class="novedad-fecha">${fechaFormateada}</div>
      </div>
      <div class="novedad-contenido">${novedad.contenido}</div>
      <div style="margin-top:8px;font-size:12px;color:var(--muted)">Publicado por: ${novedad.autor}</div>
      <button class="novedad-eliminar" onclick="eliminarNovedad(${novedad.id})" title="Eliminar novedad">
        <i class="fas fa-trash"></i>
      </button>
    `;
    
    container.appendChild(card);
  });
}

function agregarNovedad(e){
  e.preventDefault();
  const titulo = document.getElementById('novedad-titulo').value.trim();
  const contenido = document.getElementById('novedad-contenido').value.trim();
  
  if(!titulo || !contenido){ 
    mostrarPopup('Complete todos los campos','error'); 
    return; 
  }
  
  const id = novedades.length ? Math.max(...novedades.map(n=>n.id)) + 1 : 1;
  const fecha = new Date().toISOString().split('T')[0];
  
  novedades.push({
    id,
    titulo,
    contenido,
    fecha,
    autor: usuarioActual.nombre
  });
  
  guardarDatos();
  mostrarPopup('Novedad publicada correctamente','success');
  document.getElementById('add-novedad-form').reset();
  cargarNovedadesAdmin();
  
  // Actualizar notificación para usuarios
  actualizarNotificacionNovedades();
  
  // Si estamos en la sección de novedades, actualizarla también
  if(document.getElementById('novedades').style.display === 'block') {
    cargarNovedades();
  }
}

function eliminarNovedad(id){
  if(!confirm('¿Está seguro de que desea eliminar esta novedad?')) return;
  
  novedades = novedades.filter(n => n.id !== id);
  guardarDatos();
  mostrarPopup('Novedad eliminada','success');
  cargarNovedadesAdmin();
  
  // Actualizar notificación para usuarios
  actualizarNotificacionNovedades();
  
  // Si estamos en la sección de novedades, actualizarla también
  if(document.getElementById('novedades').style.display === 'block') {
    cargarNovedades();
  }
}

/* ===========================
   Notificaciones de Novedades
   =========================== */
function actualizarNotificacionNovedades() {
  if (usuarioActual && !usuarioActual.admin) {
    const badge = document.getElementById('novedades-badge');
    if (novedades.length > 0) {
      badge.textContent = novedades.length;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

/* ===========================
   Admin: historial general
   =========================== */
function cargarHistorialGeneral(){
  const tbody = document.getElementById('historial-general-body');
  if(!tbody) return; // se usa sólo si la sección admin-historial está presente
}

/* ===========================
   Admin: actualización resumen
   =========================== */
function actualizarAdminDashboard(){
  document.getElementById('total-usuarios').textContent = usuarios.filter(u=>!u.admin).length;
  document.getElementById('total-registros').textContent = registros.length;
  document.getElementById('total-actividades').textContent = actividades.length;
  document.getElementById('total-novedades').textContent = novedades.length;
}

/* ===========================
   Export CSV
   =========================== */
function exportarCSV(){
  if(!registros.length){ mostrarPopup('No hay registros para exportar','error'); return; }
  const rows = [
    ['legajo','nombre','actividad','fecha','ingreso','salida','horas','movil','estadoMovil','observaciones','observacionesSalida']
  ];
  registros.forEach(r=>{
    const usuario = usuarios.find(u=> u.legajo === r.legajo);
    rows.push([
      r.legajo,
      usuario ? usuario.nombre : '',
      r.actividad || '',
      r.fecha || '',
      r.ingreso || '',
      r.salida || '',
      r.horas || '',
      r.movil || '',
      r.estadoMovil || '',
      (r.observaciones || '').replace(/\n/g,' '),
      (r.observacionesSalida || '').replace(/\n/g,' ')
    ]);
  });

  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `registros_bomberos_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  mostrarPopup('CSV descargado', 'success');
}

/* ===========================
   Util: confirmar eliminar (ejemplo)
   =========================== */
function confirmEliminarActividad(id){
  if(confirm('¿Eliminar actividad?')) eliminarActividad(id);
}

/* ===========================
   Seguridad mínima: cerrar sesión
   =========================== */
document.getElementById('logout-top').addEventListener('click', ()=>{
  localStorage.removeItem(STORAGE.SESSION);
  location.reload();
});

</script>
</body>
</html>
